<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CS9 Game — Reconstruction Amendments</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --text:#e7eefc;
      --muted:#a8b4cf;
      --accent:#7aa2ff;
      --good:#2bd576;
      --bad:#ff5c7a;
      --warn:#ffd166;
      --border: rgba(255,255,255,0.10);
      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background: radial-gradient(900px 500px at 20% 0%, rgba(122,162,255,.22), transparent 55%),
                  radial-gradient(900px 500px at 80% 10%, rgba(43,213,118,.12), transparent 60%),
                  var(--bg);
      min-height:100vh;
      padding: 24px;
    }
    .wrap{max-width:1100px;margin:0 auto;}
    h1{font-size:1.35rem;margin:0 0 10px 0;letter-spacing:.2px}
    .sub{color:var(--muted);margin:0 0 18px 0;line-height:1.35}
    .grid{display:grid;grid-template-columns: 1.25fr .75fr;gap:16px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr; } }
    .card{
      background: rgba(17,26,46,.82);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      color: var(--text);
      font-size:.92rem;
    }
    .pill strong{font-family:var(--mono);font-weight:800}
    .btn{
      cursor:pointer;
      border:none;
      border-radius: 12px;
      padding:10px 12px;
      color: var(--text);
      background: rgba(122,162,255,.18);
      border:1px solid rgba(122,162,255,.35);
      transition: transform .06s ease, background .15s ease;
      font-weight:800;
    }
    .btn:hover{background: rgba(122,162,255,.26)}
    .btn:active{transform: scale(.98)}
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      font-weight:700;
    }
    .btn.danger{
      background: rgba(255,92,122,.14);
      border:1px solid rgba(255,92,122,.35);
    }
    .label{color:var(--muted);font-size:.85rem}
    .mono{font-family:var(--mono)}
    .value{font-weight:900}
    .qbox h2{margin:0 0 10px 0;font-size:1.08rem}
    .prompt{font-size:1.03rem;line-height:1.38;margin:8px 0 12px 0}
    .choices{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 700px){ .choices{grid-template-columns:1fr} }
    .choice{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius: var(--radius2);
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      cursor:pointer;
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
      user-select:none;
    }
    .choice:hover{background: rgba(255,255,255,.075)}
    .choice:active{transform: scale(.99)}
    .choice .tag{
      width: 28px; height:28px; border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(122,162,255,.18);
      border:1px solid rgba(122,162,255,.28);
      font-weight:900;
      flex:0 0 auto;
    }
    .choice.correct{
      border-color: rgba(43,213,118,.55);
      background: rgba(43,213,118,.10);
    }
    .choice.wrong{
      border-color: rgba(255,92,122,.55);
      background: rgba(255,92,122,.10);
    }
    .feedback{
      margin-top:12px;
      padding:12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      display:none;
    }
    .feedback.good{display:block;border-color: rgba(43,213,118,.45);background: rgba(43,213,118,.08)}
    .feedback.bad{display:block;border-color: rgba(255,92,122,.45);background: rgba(255,92,122,.08)}
    .feedback .title{font-weight:900;margin-bottom:6px}
    .teacherPanel{
      display:none;
      margin-top:12px;
      padding:12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.25);
      background: rgba(255,255,255,.03);
    }
    .teacherPanel.show{display:block}
    #timeBox .row2{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
      align-items:stretch;
    }
    @media (max-width: 860px){
      #timeBox .row2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    pre{
      white-space: pre-wrap;
      word-break: break-word;
      margin:0;
      font-family: var(--mono);
      font-size:.92rem;
      line-height:1.35;
    }
    .tiny{font-size:.86rem;color:var(--muted)}
    .divider{height:1px;background: var(--border); margin: 12px 0;}
    .input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-weight:800;
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <div>
        <h1>CS9 — Reconstruction Amendments (13th, 14th, 15th)</h1>
        <p class="sub">Goal: identify the amendment + match the “trigger/cause” + connect to continued inequality (Black Codes, Jim Crow). Must reach <strong>100%</strong> to unlock submission screenshot.</p>
      </div>
      <div class="spacer"></div>
      <button class="btn secondary" id="toggleTeacherBtn" title="Teacher Mode: ?teacher=1 or Shift+T">Teacher Mode</button>
      <button class="btn danger" id="resetBtn" title="Reset progress (local only)">Reset</button>
    </div>

    <div class="divider"></div>

    <div id="startCard" class="row" style="gap:12px;">
      <div style="flex:1;min-width:260px;">
        <div class="label">Student Name (required)</div>
        <input id="nameInput" class="input" placeholder="Type first + last name" autocomplete="off" />
        <div class="tiny">Tip: This prevents “copied screenshot” issues. Name appears in the timer + submission summary.</div>
      </div>
      <button class="btn" id="startBtn">Start Game</button>
    </div>

    <div id="timeBox" class="card" style="margin-top:12px;display:none;">
      <div class="row2">
        <div>
          <div class="label">Student</div>
          <div id="studentNameDisplay" class="value">—</div>
        </div>
        <div>
          <div class="label">Start Time</div>
          <div id="startStamp" class="value">—</div>
        </div>
        <div>
          <div class="label">Elapsed</div>
          <div id="timerClock" class="value mono">00:00</div>
        </div>
        <div>
          <div class="label">Last Action</div>
          <div id="lastActionStamp" class="value">—</div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="pill">Question: <strong id="qNum">—</strong>/<strong id="qTotal">—</strong></div>
      <div class="pill">Correct: <strong id="correctCount">0</strong></div>
      <div class="pill">Attempts: <strong id="attemptCount">0</strong></div>
      <div class="pill">Accuracy: <strong id="accuracy">0</strong>%</div>
      <div class="spacer"></div>
      <!-- Next removed -->
    </div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card qbox">
      <h2>Question</h2>
      <div id="prompt" class="prompt">Enter your name and click Start.</div>

      <div class="choices" id="choices"></div>

      <div id="feedback" class="feedback">
        <div class="title" id="fbTitle"></div>
        <div id="fbText" class="tiny"></div>
      </div>

      <div id="teacherPanel" class="teacherPanel">
        <div class="label">Teacher Mode is ON</div>
        <div class="tiny">Explanations will appear after an incorrect answer. Students cannot open “hints” before answering.</div>
        <div class="tiny mono">Shortcut: Shift+T toggles this panel.</div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:1.08rem;">Rules</h2>
      <ul class="tiny" style="margin:0 0 10px 18px;line-height:1.5;">
        <li>Click an answer to submit.</li>
        <li>If correct: auto-advances to the next question.</li>
        <li>If wrong: you get a hint and retry immediately (the miss counts in accuracy).</li>
        <li>Teacher Mode shows an explanation only <strong>after a wrong answer</strong>.</li>
        <li>Submission summary appears only at <strong>100% accuracy</strong>.</li>
      </ul>

      <div class="divider"></div>

      <section id="submissionBox" class="card" style="display:none;">
        <div class="label">Submission Summary (Screenshot this)</div>
        <pre id="submissionText" style="margin-top:10px;"></pre>
      </section>
    </div>
  </div>

</div>

<script>
/** =========================
 *  UTILITIES
 *  ========================= */
const $ = (sel) => document.querySelector(sel);
const shuffle = (arr) => {
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
};

const AUTO_ADVANCE_MS = 450;

/** =========================
 *  TIMER + TIMESTAMP SYSTEM
 *  ========================= */
const Time = (() => {
  const pad = (n) => String(n).padStart(2,'0');
  const fmtClock = (ms) => {
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${pad(m)}:${pad(r)}`;
  };
  const fmtStamp = (d=new Date()) => {
    return d.toLocaleString([], { year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit' });
  };
  return { fmtClock, fmtStamp };
})();

const Run = {
  startedAt: null,
  timerId: null,
  lastActionAt: null,
  qShownAt: null,
  log: [],

  init(studentName){
    this.startedAt = Date.now();
    this.lastActionAt = Date.now();
    this.qShownAt = Date.now();

    $("#studentNameDisplay").textContent = studentName || "—";
    $("#startStamp").textContent = Time.fmtStamp(new Date(this.startedAt));
    $("#lastActionStamp").textContent = Time.fmtStamp(new Date(this.lastActionAt));

    this.timerId = setInterval(() => {
      $("#timerClock").textContent = Time.fmtClock(Date.now() - this.startedAt);
    }, 250);

    this.pushLog({ type:"START", detail:"Game started", stamp:this.lastActionAt });
  },

  markAction(type, detail){
    this.lastActionAt = Date.now();
    $("#lastActionStamp").textContent = Time.fmtStamp(new Date(this.lastActionAt));
    this.pushLog({ type, detail, stamp:this.lastActionAt });
  },

  markQuestionShown(qIndex, qLabel){
    this.qShownAt = Date.now();
    this.markAction("Q_SHOWN", `Q${qIndex+1}: ${qLabel||""}`.trim());
  },

  recordAnswer({ qIndex, prompt, choiceLabel, choiceText, isCorrect, correctLabel, reasonText }){
    const now = Date.now();
    const timeOnQ = Math.max(0, Math.round((now - (this.qShownAt || now)) / 1000));
    this.pushLog({
      type: isCorrect ? "ANSWER_CORRECT" : "ANSWER_WRONG",
      stamp: now,
      qIndex,
      timeOnQ,
      prompt,
      choice: `${choiceLabel}. ${choiceText}`,
      correct: correctLabel || "",
      reason: reasonText || ""
    });
    this.lastActionAt = now;
    $("#lastActionStamp").textContent = Time.fmtStamp(new Date(now));
  },

  pushLog(entry){ this.log.push(entry); },

  elapsedMs(){ return this.startedAt ? (Date.now() - this.startedAt) : 0; },

  buildSummary({ studentName, accuracy, correctCount, totalCount }){
    const endTime = new Date();
    const elapsed = Time.fmtClock(this.elapsedMs());
    const rows = this.log
      .filter(e => e.type === "ANSWER_CORRECT" || e.type === "ANSWER_WRONG")
      .map(e => {
        const stamp = Time.fmtStamp(new Date(e.stamp));
        const result = e.type === "ANSWER_CORRECT" ? "✅" : "❌";
        return `${result} ${stamp} | Q${(e.qIndex ?? 0)+1} | +${e.timeOnQ}s | ${e.choice} | Correct: ${e.correct}`;
      });

    return [
      `GAME:    CS9 — Reconstruction Amendments`,
      `STUDENT: ${studentName || "—"}`,
      `START:   ${Time.fmtStamp(new Date(this.startedAt))}`,
      `END:     ${Time.fmtStamp(endTime)}`,
      `ELAPSED: ${elapsed}`,
      `SCORE:   ${correctCount}/${totalCount} (${accuracy}%)`,
      ``,
      `ANSWER LOG:`,
      ...(rows.length ? rows : [`(no answers logged)`])
    ].join("\n");
  }
};

/** =========================
 *  QUESTION BANK (CS9)
 *  (unchanged)
 *  ========================= */
const QUESTIONS = [
  {
    id:"CS9-13A-1",
    prompt:"Which amendment abolished slavery nationwide?",
    choices:["13th Amendment","14th Amendment","15th Amendment","10th Amendment"],
    answer:0,
    explain:"13th abolished slavery. The federal government had to amend the Constitution (10th Amendment reserves powers to states unless the Constitution says otherwise)."
  },
  {
    id:"CS9-13A-2",
    prompt:"Why did the federal government need the 13th Amendment after the Civil War ended?",
    choices:[
      "Because the 10th Amendment left slavery policy to the states unless the Constitution was changed",
      "Because the Supreme Court required it to create DC electoral votes",
      "Because women demanded the right to vote",
      "Because Jefferson and Burr tied in electoral votes"
    ],
    answer:0,
    explain:"Your class framing: the 10th Amendment meant the federal government had to explicitly add slavery’s ban to the Constitution."
  },
  {
    id:"CS9-13A-3",
    prompt:"Which option is a direct protection created by the Reconstruction Amendments?",
    choices:[
      "Abolishing slavery",
      "Lowering the voting age to 18",
      "Creating presidential term limits",
      "Giving DC statehood"
    ],
    answer:0,
    explain:"Abolishing slavery is the 13th Amendment (Reconstruction Amendment)."
  },
  {
    id:"CS9-13A-4",
    prompt:"Which amendment is most directly connected to ending slavery as a legal institution?",
    choices:["13th","14th","15th","19th"],
    answer:0,
    explain:"13th ends slavery. 14th defines citizenship/equal protection. 15th addresses voting rights based on race."
  },

  {
    id:"CS9-14A-1",
    prompt:"Which amendment defined and extended citizenship to people born or naturalized in the U.S.?",
    choices:["14th Amendment","15th Amendment","13th Amendment","22nd Amendment"],
    answer:0,
    explain:"14th Amendment: citizenship clause + due process + equal protection."
  },
  {
    id:"CS9-14A-2",
    prompt:"Southern states denied citizenship and used Black Codes after the Civil War. Which amendment responded by defining citizenship?",
    choices:["14th Amendment","12th Amendment","24th Amendment","23rd Amendment"],
    answer:0,
    explain:"14th was designed to protect freedpeople by defining national citizenship."
  },
  {
    id:"CS9-14A-3",
    prompt:"Which two protections are most associated with the 14th Amendment?",
    choices:[
      "Due process + equal protection",
      "Term limits + succession rules",
      "Women’s suffrage + poll tax ban",
      "Separate ballots for president and VP"
    ],
    answer:0,
    explain:"14th: due process and equal protection (applied against states)."
  },
  {
    id:"CS9-14A-4",
    prompt:"Which statement best explains why the 14th Amendment was needed?",
    choices:[
      "States were denying citizenship and legal protections to freedpeople, and the Constitution had to be amended to stop it",
      "The U.S. needed to limit presidents to two terms",
      "DC’s population required statehood",
      "18-year-olds demanded the right to vote"
    ],
    answer:0,
    explain:"Your causation framing: without an explicit constitutional rule, states claimed authority under the 10th; 14th added citizenship/due process/equal protection."
  },
  {
    id:"CS9-14A-5",
    prompt:"A state passes a law that treats one race differently under the law. Which amendment is most directly violated?",
    choices:["14th Amendment (Equal Protection)","13th Amendment","22nd Amendment","12th Amendment"],
    answer:0,
    explain:"Equal Protection Clause is in the 14th Amendment."
  },
  {
    id:"CS9-14A-6",
    prompt:"Which is the best example of continued struggle despite Reconstruction Amendments?",
    choices:["Jim Crow segregation laws","DC receiving electoral votes","Women voting in 1920","Presidential term limits"],
    answer:0,
    explain:"Jim Crow laws enforced segregation for decades, showing that amendments did not produce immediate equality."
  },
  {
    id:"CS9-14A-7",
    prompt:"The 14th Amendment limited states by requiring what when they apply laws to people?",
    choices:["Due process and equal protection","Poll taxes to be removed","Separate ballots for president/VP","Two-term limit"],
    answer:0,
    explain:"14th Amendment: states cannot deny due process or equal protection."
  },
  {
    id:"CS9-14A-8",
    prompt:"Which is a correct cause/effect relationship for the 14th Amendment?",
    choices:[
      "Cause: States denied citizenship/protections → Effect: Constitution amended to define citizenship and require equal protection",
      "Cause: Jefferson-Burr tie → Effect: Two-term limit",
      "Cause: Vietnam draft → Effect: Poll tax ban",
      "Cause: DC population growth → Effect: Women’s suffrage"
    ],
    answer:0,
    explain:"That’s the clean trigger chain: state abuse/denial → national constitutional protections."
  },

  {
    id:"CS9-15A-1",
    prompt:"Which amendment prevents denying the right to vote based on race, color, or previous condition of servitude?",
    choices:["15th Amendment","14th Amendment","13th Amendment","26th Amendment"],
    answer:0,
    explain:"15th Amendment: voting rights protection based on race/color/previous servitude."
  },
  {
    id:"CS9-15A-2",
    prompt:"Which Reconstruction Amendment was most directly intended to protect Black men’s voting rights after the Civil War?",
    choices:["15th Amendment","13th Amendment","14th Amendment","24th Amendment"],
    answer:0,
    explain:"15th focuses on voting rights; 13th ends slavery; 14th defines citizenship/equals protection."
  },
  {
    id:"CS9-15A-3",
    prompt:"Southern states tried to prevent freed Black men from voting. Why was an amendment needed (per your class framing)?",
    choices:[
      "Because without a constitutional rule, states claimed authority under the 10th Amendment to control voting",
      "Because presidents needed term limits",
      "Because DC had no electors",
      "Because women served on the home front in WWI"
    ],
    answer:0,
    explain:"Your causation emphasis: the Constitution needed explicit language to constrain states."
  },
  {
    id:"CS9-15A-4",
    prompt:"Which is the best example of how equality still did not happen immediately after the 15th Amendment?",
    choices:[
      "States used Jim Crow systems to block Black voting despite the amendment",
      "The president could now serve only two terms",
      "DC became a state",
      "18-year-olds could vote"
    ],
    answer:0,
    explain:"The 15th existed, but Jim Crow-era barriers persisted for decades."
  },

  {
    id:"CS9-MIX-1",
    prompt:"Which set correctly matches the Reconstruction Amendments?",
    choices:[
      "13th, 14th, 15th",
      "12th, 22nd, 25th",
      "19th, 24th, 26th",
      "1st, 4th, 5th"
    ],
    answer:0,
    explain:"Reconstruction Amendments are 13th, 14th, and 15th."
  },
  {
    id:"CS9-MIX-2",
    prompt:"Which amendment is MOST connected to “equal protection of the laws”?",
    choices:["14th","13th","15th","23rd"],
    answer:0,
    explain:"Equal Protection Clause is in the 14th Amendment."
  },
  {
    id:"CS9-MIX-3",
    prompt:"Which amendment is MOST connected to “abolishing slavery”?",
    choices:["13th","14th","15th","24th"],
    answer:0,
    explain:"13th abolishes slavery."
  },
  {
    id:"CS9-MIX-4",
    prompt:"Which amendment is MOST connected to “voting cannot be denied based on race”?",
    choices:["15th","14th","13th","12th"],
    answer:0,
    explain:"15th protects voting rights from race-based denial."
  },
  {
    id:"CS9-MIX-5",
    prompt:"Which is a valid reason Reconstruction Amendments did NOT create immediate equality?",
    choices:[
      "States created Jim Crow laws and practices that limited rights in reality even if amendments existed on paper",
      "The Constitution banned voting for women until 1971",
      "DC was not allowed to vote for electors",
      "Presidents had no succession rules"
    ],
    answer:0,
    explain:"Jim Crow systems enforced segregation and voting barriers long after Reconstruction."
  },
  {
    id:"CS9-MIX-6",
    prompt:"Which statement best captures the overall purpose of the Reconstruction Amendments?",
    choices:[
      "To extend new constitutional protections to African Americans after the Civil War",
      "To limit presidents to two terms",
      "To give DC statehood",
      "To lower the voting age"
    ],
    answer:0,
    explain:"That’s exactly Content Statement 9: new protections for African Americans, though equality remained a struggle."
  },
  {
    id:"CS9-MIX-7",
    prompt:"Which is the best “cause → amendment” match?",
    choices:[
      "Black Codes/Jim Crow denial of rights → 14th/15th added protections against state abuses",
      "Jefferson-Burr tie → 22nd created term limits",
      "Vietnam draft → 24th banned poll taxes",
      "DC population growth → 19th gave women voting rights"
    ],
    answer:0,
    explain:"Jefferson/Burr tie = 12th. Vietnam draft = 26th. DC growth = 23rd. WWI homefront shift = 19th."
  },
  {
    id:"CS9-MIX-8",
    prompt:"A state denies a person fair legal procedures before taking property. Which Reconstruction Amendment is most relevant?",
    choices:["14th (Due Process)","13th","15th","22nd"],
    answer:0,
    explain:"Due Process Clause is in the 14th Amendment."
  }
];

/** =========================
 *  GAME STATE
 *  ========================= */
const state = {
  teacherMode: false,
  started: false,
  studentName: "",
  deck: [],
  i: 0,
  correct: 0,
  attempts: 0,
  missedQueue: [],
  answeredCorrectly: new Set(),
  currentChoices: [],
  currentCorrectIndex: 0,
  locked: false
};

function parseTeacherFromURL(){
  const u = new URL(location.href);
  return u.searchParams.get("teacher") === "1";
}
function setTeacherMode(on){
  state.teacherMode = !!on;
  $("#toggleTeacherBtn").textContent = state.teacherMode ? "Teacher Mode: ON" : "Teacher Mode";
  $("#teacherPanel").classList.toggle("show", state.teacherMode);
  if(state.started) Run.markAction("TEACHER_MODE", state.teacherMode ? "ON" : "OFF");
}

function resetAll(){
  state.started=false;
  state.studentName="";
  state.deck=[];
  state.i=0;
  state.correct=0;
  state.attempts=0;
  state.missedQueue=[];
  state.answeredCorrectly = new Set();
  state.currentChoices=[];
  state.currentCorrectIndex=0;
  state.locked=false;

  $("#qNum").textContent="—";
  $("#qTotal").textContent="—";
  $("#correctCount").textContent="0";
  $("#attemptCount").textContent="0";
  $("#accuracy").textContent="0";
  $("#prompt").textContent="Enter your name and click Start.";
  $("#choices").innerHTML="";
  $("#feedback").className="feedback";
  $("#feedback").style.display="none";

  $("#submissionBox").style.display="none";
  $("#submissionText").textContent="";

  $("#timeBox").style.display="none";
  $("#startCard").style.display="flex";
}

function accuracyPct(){
  return state.attempts===0 ? 0 : Math.round((state.correct/state.attempts)*100);
}
function updateHud(){
  $("#qNum").textContent = state.started ? String(state.i+1) : "—";
  $("#qTotal").textContent = state.started ? String(state.deck.length) : "—";
  $("#correctCount").textContent = String(state.correct);
  $("#attemptCount").textContent = String(state.attempts);
  $("#accuracy").textContent = String(accuracyPct());
}
function buildDeck(){ state.deck = shuffle(QUESTIONS); }

function buildHint(q){
  const p=(q.prompt||"").toLowerCase();

  if(p.includes("abolish") || p.includes("slavery")) return "Hint: The first Reconstruction Amendment ends slavery.";
  if(p.includes("citizenship") || p.includes("equal protection") || p.includes("due process")) return "Hint: The middle Reconstruction Amendment is citizenship + due process + equal protection.";
  if(p.includes("vote") && (p.includes("race") || p.includes("color") || p.includes("servitude"))) return "Hint: The last Reconstruction Amendment is about voting rights and race.";
  if(p.includes("jim crow") || p.includes("black codes")) return "Hint: Think which amendment was meant to stop states from denying legal protection/citizenship.";
  if(p.includes("property") || p.includes("procedures")) return "Hint: Due process is the key phrase.";
  return "Hint: 13th = ends slavery; 14th = citizenship/due process/equal protection; 15th = voting rights (race).";
}

function renderQuestion(){
  $("#feedback").className="feedback";
  $("#feedback").style.display="none";
  $("#fbTitle").textContent="";
  $("#fbText").textContent="";
  state.locked=false;

  const q = state.deck[state.i];
  $("#prompt").textContent = q.prompt;

  const labeled = q.choices.map((t,idx)=>({ text:t, origIndex: idx }));
  const shuffled = shuffle(labeled);
  state.currentChoices = shuffled;
  state.currentCorrectIndex = shuffled.findIndex(x => x.origIndex === q.answer);

  const letters = ["A","B","C","D"];
  $("#choices").innerHTML = "";
  shuffled.forEach((opt,idx)=>{
    const div = document.createElement("div");
    div.className="choice";
    div.tabIndex=0;
    div.innerHTML = `
      <div class="tag">${letters[idx]}</div>
      <div>
        <div style="font-weight:850">${opt.text}</div>
      </div>
    `;
    div.addEventListener("click", ()=>grade(idx));
    div.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"||e.key===" "){ e.preventDefault(); grade(idx); }
    });
    $("#choices").appendChild(div);
  });

  Run.markQuestionShown(state.i, q.id || "CS9");
  updateHud();
}

function grade(picked){
  if(!state.started || state.locked) return;
  state.locked=true;

  const q = state.deck[state.i];
  const letters = ["A","B","C","D"];
  const correct = state.currentCorrectIndex;

  // attempt counts ONLY on answer click
  state.attempts += 1;
  updateHud();

  const isCorrect = picked === correct;

  const nodes = Array.from($("#choices").children);
  nodes.forEach((node, idx)=>{
    node.classList.remove("correct","wrong");
    if(idx===correct) node.classList.add("correct");
    if(idx===picked && !isCorrect) node.classList.add("wrong");
  });

  Run.recordAnswer({
    qIndex: state.i,
    prompt: q.prompt,
    choiceLabel: letters[picked],
    choiceText: state.currentChoices[picked].text,
    isCorrect,
    correctLabel: letters[correct],
    reasonText: q.explain || ""
  });

  $("#feedback").style.display="block";

  if(isCorrect){
    state.correct += 1;
    state.answeredCorrectly.add(q.id);

    $("#feedback").className="feedback good";
    $("#fbTitle").textContent = "Correct ✅";
    $("#fbText").textContent = "Next question…";

    updateHud();
    maybeUnlockSubmission();

    setTimeout(()=>next(), AUTO_ADVANCE_MS);

  } else {
    state.missedQueue.push(q);

    $("#feedback").className="feedback bad";
    $("#fbTitle").textContent = "Incorrect ❌";
    const hint = buildHint(q);

    $("#fbText").textContent = state.teacherMode
      ? `Hint: ${hint}\nExplanation: ${q.explain}`
      : `Hint: ${hint}`;

    maybeUnlockSubmission();
    state.locked=false; // allow retry immediately
  }
}

function maybeUnlockSubmission(){
  const acc = accuracyPct();
  if(acc === 100 && state.answeredCorrectly.size === QUESTIONS.length){
    $("#submissionBox").style.display="block";
    $("#submissionText").textContent = Run.buildSummary({
      studentName: state.studentName,
      accuracy: acc,
      correctCount: state.correct,
      totalCount: state.attempts
    });
  }
}

function next(){
  if(state.i >= state.deck.length - 1){
    if(state.missedQueue.length > 0){
      const missed = state.missedQueue.slice();
      state.missedQueue = [];
      state.deck = shuffle(missed);
      state.i = 0;
      renderQuestion();
      return;
    } else {
      state.deck = shuffle(QUESTIONS);
      state.i = 0;
      renderQuestion();
      return;
    }
  } else {
    state.i += 1;
    renderQuestion();
  }
}

/** =========================
 *  STARTUP + EVENTS
 *  ========================= */
function startGame(){
  const name = ($("#nameInput").value || "").trim();
  if(name.length < 3){
    alert("Please enter your full name (first + last).");
    $("#nameInput").focus();
    return;
  }
  state.studentName = name;
  state.started = true;

  $("#startCard").style.display="none";
  $("#timeBox").style.display="block";

  buildDeck();
  state.i = 0;

  Run.init(name);
  Run.markAction("START_CLICK", "Student started the game");

  $("#qTotal").textContent = String(state.deck.length);
  renderQuestion();
}

$("#startBtn").addEventListener("click", startGame);
$("#resetBtn").addEventListener("click", ()=>{
  if(confirm("Reset local progress for this game?")){
    location.reload();
  }
});
$("#toggleTeacherBtn").addEventListener("click", ()=>setTeacherMode(!state.teacherMode));

window.addEventListener("keydown",(e)=>{
  if(e.shiftKey && e.key.toLowerCase()==="t"){
    setTeacherMode(!state.teacherMode);
  }
  if(!state.started || state.locked) return;

  // Keyboard answer shortcuts 1-4 submit immediately
  if(["1","2","3","4"].includes(e.key)){
    grade(parseInt(e.key,10)-1);
  }
});

(function init(){
  resetAll();
  setTeacherMode(parseTeacherFromURL());
})();
</script>
</body>
</html>
