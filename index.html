<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bill of Rights — Which Amendment Is Being Violated?</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111b2e;
      --card:#0f1a2c;
      --text:#e7eefc;
      --muted:#a8b4cf;
      --accent:#7aa2ff;
      --good:#2bd576;
      --bad:#ff5c7a;
      --warn:#ffd166;
      --border: rgba(255,255,255,0.10);
      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(900px 500px at 15% 15%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 85% 25%, rgba(43,213,118,.14), transparent 60%),
                  radial-gradient(900px 500px at 60% 85%, rgba(255,92,122,.12), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }

    .app{
      width: min(1040px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
    }

    header{
      padding: 18px 18px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .title-wrap{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-width: 720px;
    }
    h1{
      font-size: 20px;
      margin:0;
      letter-spacing:.2px;
    }
    .sub{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.25;
    }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }
    .pill b{color: var(--text); font-weight:700}

    main{
      padding: 18px;
      display:grid;
      grid-template-columns: 1.08fr .92fr;
      gap: 14px;
    }

    @media (max-width: 900px){
      main{grid-template-columns: 1fr}
    }

    .card{
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: 14px;
    }

    .scenario{
      background: linear-gradient(180deg, rgba(122,162,255,.10), rgba(0,0,0,.18));
      border:1px solid rgba(122,162,255,.22);
      border-radius: var(--radius2);
      padding: 16px;
      min-height: 170px;
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .scenario::after{
      content:"";
      position:absolute;
      inset:-60px -80px auto auto;
      width: 240px;
      height: 240px;
      background: radial-gradient(circle, rgba(122,162,255,.22), transparent 60%);
      transform: rotate(18deg);
    }

    .scenario-label{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(231,238,252,.75);
      letter-spacing:.6px;
      text-transform:uppercase;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    .badge{
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color: var(--muted);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }

    .scenario-text{
      font-size: 17px;
      line-height: 1.35;
      margin:0;
      position:relative;
      z-index:1;
    }

    .choices{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width: 540px){
      .choices{grid-template-columns: repeat(2, minmax(0,1fr))}
    }

    button{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 12px 10px;
      border-radius: 14px;
      font-size: 14px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.16); }
    button:active{ transform: translateY(1px); }
    button.primary{
      border-color: rgba(122,162,255,.35);
      background: rgba(122,162,255,.12);
    }
    button.primary:hover{ background: rgba(122,162,255,.18); }
    button.good{
      border-color: rgba(43,213,118,.40);
      background: rgba(43,213,118,.14);
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    .feedback{
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      min-height: 54px;
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .feedback .icon{
      width: 18px;
      height: 18px;
      border-radius: 6px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size: 12px;
      margin-top:2px;
      flex: 0 0 auto;
    }
    .icon.good{ background: rgba(43,213,118,.16); color: var(--good); border:1px solid rgba(43,213,118,.35); }
    .icon.bad{ background: rgba(255,92,122,.16); color: var(--bad); border:1px solid rgba(255,92,122,.35); }
    .icon.warn{ background: rgba(255,209,102,.16); color: var(--warn); border:1px solid rgba(255,209,102,.35); }

    .explain{
      margin-top: 12px;
      display:none;
      border-radius: 14px;
      border:1px solid rgba(43,213,118,.30);
      background: linear-gradient(180deg, rgba(43,213,118,.10), rgba(0,0,0,.18));
      padding: 12px;
    }
    .explain h3{ margin:0 0 8px; font-size: 14px; }
    .explain .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .explain b{ color: var(--text); }
    .mini{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(231,238,252,.70);
      margin-top: 8px;
    }

    .sidebar h2{
      margin:0 0 10px;
      font-size: 15px;
      color: var(--text);
    }
    .help{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      margin:0 0 12px;
    }

    .rulebox{
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .rule{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .dot{
      width:10px;height:10px;border-radius:3px;margin-top:5px;flex:0 0 auto;
      border:1px solid var(--border);
      background: rgba(122,162,255,.22);
      border-color: rgba(122,162,255,.32);
    }
    .footer{
      padding: 14px 18px 18px;
      border-top:1px solid var(--border);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }
    .linkish{
      color: rgba(231,238,252,.75);
      text-decoration: underline;
      cursor:pointer;
    }
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modal .box{
      width: min(860px, 100%);
      background: #0f172a;
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .modal h3{ margin:0 0 10px; }
    .modal pre{
      margin: 10px 0 0;
      padding: 12px;
      background: rgba(0,0,0,.20);
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:auto;
      color: rgba(231,238,252,.9);
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .modal .row{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top: 12px;
      flex-wrap:wrap;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-wrap">
        <h1>Bill of Rights — Which Amendment Is Being Violated?</h1>
        <div class="sub">Read the scenario. Choose the amendment that best applies. You can’t advance until you’re correct — then you’ll see the right + government limit explanation (CS 8 / OST).</div>
      </div>

      <div class="stats">
        <div class="pill">Scenario <b id="qNum">1</b>/<b id="qTotal">0</b></div>
        <div class="pill">Correct <b id="correctCt">0</b></div>
        <div class="pill">Total Attempts <b id="attemptCt">0</b></div>
        <div class="pill">This Scenario Attempts <b id="attemptThis">0</b></div>
        <div class="pill">Accuracy <b id="accPct">—</b></div>
        <div class="pill">Timer <b id="timeEl">0:00</b></div>
        <div class="pill">Now <b id="nowStamp">—</b></div>
        <div class="pill">Started <b id="startStamp">—</b></div>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="scenario">
          <div class="scenario-label">
            <span class="badge" id="modeBadge">Mode: Strict (must be correct)</span>
            <span class="badge" id="streakBadge">Streak: 0</span>
            <span class="badge" id="attemptBadge">Attempt #: 0</span>
          </div>
          <p class="scenario-text" id="scenarioText">Loading…</p>
        </div>

        <div class="choices" id="choices"></div>

        <div class="controls">
          <button class="primary" id="btnHint">Hint</button>
          <button id="btnSkip" title="Teacher tool: skip this scenario">Teacher Skip</button>
          <button id="btnRestart">Restart</button>
          <button id="btnOpenBank">View/Copy Scenario Bank</button>
        </div>

        <div class="feedback" id="feedback">
          <span class="icon warn">!</span>
          <div>
            <div><b>Directions:</b> Pick the amendment that applies to this scenario.</div>
            <div style="margin-top:4px">You’ll see the explanation only after the correct choice.</div>
          </div>
        </div>

        <div class="explain" id="explainBox">
          <h3 id="explainTitle">Correct</h3>
          <div class="grid" id="explainGrid"></div>
          <div class="mini" id="explainMini"></div>
          <div class="controls" style="margin-top:10px">
            <button class="good" id="btnNext">Next Scenario</button>
          </div>
        </div>
      </section>

      <aside class="card sidebar">
        <h2>Quick “Tells” (OST-ready)</h2>
        <p class="help">Students get faster by spotting the government action and the right that is being limited/protected.</p>

        <div class="rulebox">
          <div class="rule">
            <span class="dot"></span>
            <div><b>4th:</b> search/seizure, warrants, probable cause, police grabbing property or data</div>
          </div>
          <div class="rule">
            <span class="dot"></span>
            <div><b>5th:</b> self-incrimination, forced confession, double jeopardy, due process language</div>
          </div>
          <div class="rule">
            <span class="dot"></span>
            <div><b>6th:</b> trial rights — counsel, speedy/public trial, jury, confrontation, charges</div>
          </div>
          <div class="rule">
            <span class="dot"></span>
            <div><b>1st:</b> speech/press/religion/assembly/petition — government punishing expression or belief</div>
          </div>
          <div class="rule">
            <span class="dot"></span>
            <div><b>8th:</b> cruel/unusual punishment, excessive bail/fines</div>
          </div>
          <div class="rule">
            <span class="dot"></span>
            <div><b>10th:</b> power not delegated to federal gov → reserved to states/people</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <h2>Teacher Notes</h2>
        <p class="help">
          This is Game 1 (Identify amendment from a scenario). We’ll add:
          <b>Game 2</b> (Right or No Right), <b>Game 3</b> (Fix the Violation), <b>Game 4</b> (Blitz) as separate HTML files in the same repo.
        </p>

        <div class="rulebox">
          <div class="rule">
            <span class="dot"></span>
            <div><b>Strict mode:</b> ON by default. Students cannot advance until correct. Teacher Skip exists for classroom flow (you can remove it later).</div>
          </div>
        </div>
      </aside>
    </main>

    <div class="footer">
      <div>Single-file classroom game • runs offline • no student data saved</div>
      <div>
        <span class="linkish" id="toggleShuffle">Shuffle: ON</span> ·
        <span class="linkish" id="toggleStrict">Strict: ON</span>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="box">
      <h3>Scenario Bank (edit in the file)</h3>
      <div class="sub">Each item has: scenario → correct amendment → explanation used after correct answer.</div>
      <pre id="bankText"></pre>
      <div class="row">
        <button id="btnClose">Close</button>
      </div>
    </div>
  </div>

  <script>
    /********************************************************************
     * SETTINGS
     ********************************************************************/
    const AMENDMENTS = [
      { key: "1", label: "1st" },
      { key: "2", label: "2nd" },
      { key: "4", label: "4th" },
      { key: "5", label: "5th" },
      { key: "6", label: "6th" },
      { key: "8", label: "8th" },
      { key: "10", label: "10th" }
    ];

    // Strict = must be correct to advance
    let strictMode = true;
    let shuffleOn = true;

    /********************************************************************
     * SCENARIO BANK (Game 1)
     * amendment: "1","2","4","5","6","8","10"
     ********************************************************************/
    const scenarioBank = [
      {
        amendment: "1",
        scenario: "A public school suspends a student for wearing a T-shirt criticizing the mayor, even though it causes no disruption.",
        right: "Freedom of speech (expression).",
        limit: "Government cannot punish speech just because officials dislike the message.",
        why: "The action targets protected expression without a disruption-based justification."
      },
      {
        amendment: "1",
        scenario: "A city bans a local newspaper from publishing an article that accuses city officials of corruption.",
        right: "Freedom of the press.",
        limit: "Government cannot censor or punish the press for criticizing officials (prior restraint concerns).",
        why: "The ban is government censorship tied to criticism of public officials."
      },
      {
        amendment: "1",
        scenario: "A state law requires citizens to register with the government before they can attend a peaceful protest in a public park.",
        right: "Freedom of assembly (and sometimes petition).",
        limit: "Government may regulate time/place/manner, but cannot use rules to effectively block peaceful assembly.",
        why: "The restriction targets public protest/assembly; the key issue is whether it unreasonably burdens the right."
      },
      {
        amendment: "1",
        scenario: "A public employee is fired because she signed a petition asking the city council to fix unsafe sidewalks.",
        right: "Right to petition the government (and related speech).",
        limit: "Government cannot retaliate against citizens for petitioning officials about public issues.",
        why: "The firing is retaliation for petitioning government for change."
      },
      {
        amendment: "1",
        scenario: "A county passes a rule that one religion must be taught as the official belief in public school classrooms.",
        right: "Freedom of religion (Establishment/Free Exercise principles).",
        limit: "Government cannot establish an official religion or force religious practice through public institutions.",
        why: "The rule makes government favor and promote a specific religion."
      },

      {
        amendment: "2",
        scenario: "A city bans all law-abiding adults from owning any firearms in their homes for self-defense.",
        right: "Right to keep and bear arms.",
        limit: "Government may regulate firearms, but a total ban on lawful possession for self-defense raises major constitutional concerns.",
        why: "The policy is a broad prohibition on lawful home possession."
      },

      {
        amendment: "4",
        scenario: "Police enter a person’s home and search it without a warrant and without an emergency situation.",
        right: "Protection against unreasonable searches and seizures.",
        limit: "Government generally needs a warrant based on probable cause to search a home (with limited exceptions).",
        why: "A home search without a warrant or exception is the classic 4th Amendment problem."
      },
      {
        amendment: "4",
        scenario: "Officers stop a driver and search the trunk even though they have no evidence, consent, or reason to suspect a crime.",
        right: "Protection against unreasonable searches and seizures.",
        limit: "Searches usually require probable cause, consent, or another recognized legal basis.",
        why: "The search lacks probable cause or a legal exception."
      },
      {
        amendment: "4",
        scenario: "Police seize a student’s phone and scroll through private messages without permission or a warrant.",
        right: "Protection against unreasonable searches and seizures (privacy in digital data).",
        limit: "Government often needs a warrant or strong legal justification to search digital contents.",
        why: "Searching private digital communications is a search; warrant/probable cause issues apply."
      },

      {
        amendment: "5",
        scenario: "During questioning, police threaten a suspect with harsher punishment unless he confesses, and he is forced to sign a confession.",
        right: "Protection against self-incrimination (and due process).",
        limit: "Government cannot compel a person to incriminate themselves through coercion.",
        why: "The confession is forced/compelled rather than voluntary."
      },
      {
        amendment: "5",
        scenario: "After a jury finds a defendant not guilty, the prosecutor tries to put the same person on trial again for the same crime.",
        right: "Protection against double jeopardy.",
        limit: "Government cannot try someone twice for the same offense after acquittal.",
        why: "A second prosecution after a not-guilty verdict is double jeopardy."
      },

      {
        amendment: "6",
        scenario: "A defendant is put on trial but is not allowed to have a lawyer, even though he cannot afford one.",
        right: "Right to counsel.",
        limit: "Government must provide counsel in serious criminal cases if the defendant cannot afford one.",
        why: "Denial of counsel undermines a fair trial."
      },
      {
        amendment: "6",
        scenario: "A person is arrested and waits 18 months for trial even though the case is simple and delays are not justified.",
        right: "Right to a speedy trial.",
        limit: "Government must bring criminal cases to trial within a reasonable time.",
        why: "Unjustified long delays violate the speedy trial guarantee."
      },
      {
        amendment: "6",
        scenario: "At trial, the judge refuses to let the defense question the main witness who accused the defendant.",
        right: "Right to confront witnesses (cross-examination).",
        limit: "Government must allow defendants to confront and question adverse witnesses in criminal trials.",
        why: "Blocking confrontation prevents testing the reliability of accusations."
      },
      {
        amendment: "6",
        scenario: "A defendant is never told what crime he is charged with, but the trial proceeds anyway.",
        right: "Right to be informed of the charges.",
        limit: "Government must clearly inform defendants of the accusations so they can prepare a defense.",
        why: "You cannot defend yourself against unknown charges."
      },

      {
        amendment: "8",
        scenario: "A judge sets bail so high that it is clearly meant to keep the accused in jail even for a minor, nonviolent offense.",
        right: "Protection against excessive bail.",
        limit: "Government cannot use bail amounts that are excessive relative to the circumstances.",
        why: "Bail is being used as punishment rather than to ensure court appearance."
      },
      {
        amendment: "8",
        scenario: "A prison uses punishments that cause severe, unnecessary physical suffering for rule violations.",
        right: "Protection against cruel and unusual punishment.",
        limit: "Government cannot impose punishments that are inhumane or grossly disproportionate.",
        why: "The punishment is unnecessarily harsh and potentially inhumane."
      },

      {
        amendment: "10",
        scenario: "The federal government orders states to run their local schools in a specific way even though the Constitution does not give the federal government that power.",
        right: "Reserved powers (states/people).",
        limit: "Powers not delegated to the federal government are reserved to the states or the people.",
        why: "Education is primarily a state/local responsibility unless tied to a specific federal power."
      },
      {
        amendment: "10",
        scenario: "A state argues it can handle local policing rules because the Constitution does not give general police power to the federal government.",
        right: "Reserved powers (states/people).",
        limit: "States retain broad police powers for health, safety, and welfare unless federal law/constitutional powers apply.",
        why: "This scenario focuses on state authority where federal power is not delegated."
      }
    ];

    /********************************************************************
     * GAME STATE
     ********************************************************************/
    let deck = [];
    let index = 0;

    let totalAttempts = 0;
    let totalCorrect = 0;
    let streak = 0;

    let thisScenarioAttempts = 0;
    let locked = false;

    let sessionStart = new Date();
    let startTs = Date.now();
    let timerId = null;
    let nowId = null;

    const el = (id) => document.getElementById(id);

    function formatTime(ms){
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${m}:${String(r).padStart(2,"0")}`;
    }

    function formatDateTime(d){
      // Local time, readable for students
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      let hh = d.getHours();
      const ampm = hh >= 12 ? "PM" : "AM";
      hh = hh % 12; if(hh === 0) hh = 12;
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${mm}/${dd}/${yyyy} ${hh}:${mi}:${ss} ${ampm}`;
    }

    function computeAccuracy(){
      if(totalAttempts === 0) return "—";
      const pct = Math.round((totalCorrect / totalAttempts) * 100);
      return pct + "%";
    }

    function buildDeck(){
      deck = [...scenarioBank];
      if(shuffleOn){
        for(let i = deck.length - 1; i > 0; i--){
          const j = Math.floor(Math.random() * (i + 1));
          [deck[i], deck[j]] = [deck[j], deck[i]];
        }
      }
    }

    function setFeedback(kind, title, msg){
      const box = el("feedback");
      box.innerHTML = "";
      const icon = document.createElement("span");
      icon.className = `icon ${kind}`;
      icon.textContent = kind === "good" ? "✓" : kind === "bad" ? "✕" : "!";
      const wrap = document.createElement("div");
      wrap.innerHTML = `<div><b>${title}</b></div><div style="margin-top:4px">${msg}</div>`;
      box.appendChild(icon);
      box.appendChild(wrap);
    }

    function updateStats(){
      el("qNum").textContent = String(index + 1);
      el("qTotal").textContent = String(deck.length);
      el("correctCt").textContent = String(totalCorrect);
      el("attemptCt").textContent = String(totalAttempts);
      el("attemptThis").textContent = String(thisScenarioAttempts);
      el("accPct").textContent = computeAccuracy();
      el("streakBadge").textContent = `Streak: ${streak}`;
      el("attemptBadge").textContent = `Attempt #: ${thisScenarioAttempts}`;
      el("modeBadge").textContent = `Mode: ${strictMode ? "Strict (must be correct)" : "Practice"}`;
    }

    function hideExplanation(){
      el("explainBox").style.display = "none";
      locked = false;
      // re-enable choice buttons
      document.querySelectorAll("#choices button").forEach(b=> b.disabled = false);
      el("btnHint").disabled = false;
      el("btnSkip").disabled = false;
    }

    function showExplanation(card){
      const title = `Correct: ${card.amendment}${suffix(card.amendment)} Amendment`;
      el("explainTitle").textContent = title;

      const grid = el("explainGrid");
      grid.innerHTML = `
        <div><b>Right Protected:</b> ${escapeHtml(card.right)}</div>
        <div><b>Limit on Government:</b> ${escapeHtml(card.limit)}</div>
        <div><b>Why this applies:</b> ${escapeHtml(card.why)}</div>
      `;

      el("explainMini").textContent = "OST habit: Identify the government action → name the protected right → state the limit on government.";

      el("explainBox").style.display = "block";
      locked = true;

      // Disable choice buttons while explanation showing
      document.querySelectorAll("#choices button").forEach(b=> b.disabled = true);
      el("btnHint").disabled = true;
      el("btnSkip").disabled = false;
    }

    function suffix(n){
      if(n === "1") return "st";
      if(n === "2") return "nd";
      if(n === "3") return "rd";
      return "th";
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function render(){
      const card = deck[index];
      el("scenarioText").textContent = card.scenario;

      // reset attempts for this scenario
      thisScenarioAttempts = 0;
      hideExplanation();

      setFeedback("warn", "Directions", "Pick the amendment that best applies. You must be correct to move on.");
      renderChoices();
      updateStats();
    }

    function renderChoices(){
      const wrap = el("choices");
      wrap.innerHTML = "";
      AMENDMENTS.forEach(a=>{
        const btn = document.createElement("button");
        btn.className = "primary";
        btn.textContent = a.label;
        btn.addEventListener("click", ()=> answer(a.key));
        wrap.appendChild(btn);
      });
    }

    function buildHint(card){
      const t = card.scenario.toLowerCase();
      if(t.includes("warrant") || t.includes("search") || t.includes("seize") || t.includes("phone")){
        return "Hint: Look for search/seizure, privacy, warrants, or probable cause (often 4th).";
      }
      if(t.includes("confess") || t.includes("forced") || t.includes("remain silent") || t.includes("not guilty")){
        return "Hint: Look for compelled confession or being tried twice (often 5th).";
      }
      if(t.includes("lawyer") || t.includes("trial") || t.includes("witness") || t.includes("jury") || t.includes("charges")){
        return "Hint: Look for trial rights (counsel, speedy/public, jury, confrontation) (often 6th).";
      }
      if(t.includes("newspaper") || t.includes("protest") || t.includes("petition") || t.includes("religion") || t.includes("speech")){
        return "Hint: Look for speech/press/religion/assembly/petition (often 1st).";
      }
      if(t.includes("bail") || t.includes("punish") || t.includes("prison")){
        return "Hint: Look for excessive bail or cruel/unusual punishment (often 8th).";
      }
      if(t.includes("reserved") || t.includes("states") || t.includes("not delegated") || t.includes("federal government orders states")){
        return "Hint: Look for powers not delegated to the federal government (often 10th).";
      }
      return "Hint: Identify the government action first. Then match the right being protected.";
    }

    function answer(choice){
      if(locked) return;

      totalAttempts++;
      thisScenarioAttempts++;

      const card = deck[index];
      const correct = (choice === card.amendment);

      if(correct){
        totalCorrect++;
        streak++;
        setFeedback("good", "Correct!", `Nice. You got it in ${thisScenarioAttempts} attempt(s). Read the explanation, then click Next.`);
        updateStats();
        showExplanation(card);
      } else {
        streak = 0;
        const hint = buildHint(card);
        setFeedback("bad", "Try again.", `Not that amendment. ${hint}`);
        updateStats();
      }
    }

    function next(){
      if(strictMode && el("explainBox").style.display !== "block"){
        setFeedback("warn", "Not yet.", "You must answer correctly before moving on.");
        return;
      }

      if(index < deck.length - 1){
        index++;
        render();
      } else {
        endScreen();
      }
    }

    function endScreen(){
      hideExplanation();
      const accuracy = computeAccuracy();
      const elapsed = formatTime(Date.now() - startTs);

      el("scenarioText").textContent = "Finish! Great work.";
      setFeedback("good", "Session Complete",
        `Score: ${totalCorrect} correct • Attempts: ${totalAttempts} • Accuracy: ${accuracy} • Time: ${elapsed}. Click Restart to play again.`
      );

      // Disable choices
      document.querySelectorAll("#choices button").forEach(b=> b.disabled = true);
      el("btnHint").disabled = true;

      // Show explain box with replay button
      el("explainTitle").textContent = "What next?";
      el("explainGrid").innerHTML = `
        <div><b>Replay for mastery:</b> aim for high accuracy with fewer attempts.</div>
        <div><b>Teacher move:</b> assign “2 perfect rounds” (all first-try correct) as a goal.</div>
        <div><b>Next upgrade:</b> Game 2 adds “Constitutional or Not?” before naming the amendment.</div>
      `;
      el("explainMini").textContent = "Teacher note: You can add/remove scenarios in the scenarioBank array.";
      el("explainBox").style.display = "block";

      el("btnNext").textContent = "Play Again";
      el("btnNext").onclick = () => restart();
    }

    function restart(){
      index = 0;
      totalAttempts = 0;
      totalCorrect = 0;
      streak = 0;

      sessionStart = new Date();
      startTs = Date.now();

      el("startStamp").textContent = formatDateTime(sessionStart);
      buildDeck();
      render();

      el("btnNext").textContent = "Next Scenario";
      el("btnNext").onclick = () => next();

      el("btnHint").disabled = false;
    }

    function toggleShuffle(){
      shuffleOn = !shuffleOn;
      el("toggleShuffle").textContent = `Shuffle: ${shuffleOn ? "ON" : "OFF"}`;
      restart();
    }

    function toggleStrict(){
      strictMode = !strictMode;
      el("toggleStrict").textContent = `Strict: ${strictMode ? "ON" : "OFF"}`;
      setFeedback("warn", "Mode changed",
        strictMode
          ? "Strict mode ON: you must be correct before moving on."
          : "Practice mode OFF: you can move on even if wrong (not recommended for mastery)."
      );
      updateStats();
    }

    function openBank(){
      el("modal").style.display = "flex";
      el("bankText").textContent = JSON.stringify(scenarioBank, null, 2);
    }

    function closeBank(){
      el("modal").style.display = "none";
    }

    function startTimers(){
      // running timer
      if(timerId) clearInterval(timerId);
      timerId = setInterval(()=> {
        el("timeEl").textContent = formatTime(Date.now() - startTs);
      }, 500);

      // live date/time stamp
      if(nowId) clearInterval(nowId);
      nowId = setInterval(()=> {
        el("nowStamp").textContent = formatDateTime(new Date());
      }, 1000);
    }

    // Buttons / links
    el("btnHint").addEventListener("click", ()=>{
      if(locked) return;
      const card = deck[index];
      setFeedback("warn", "Hint", buildHint(card));
    });

    el("btnSkip").addEventListener("click", ()=>{
      // teacher skip always works
      if(index < deck.length - 1){
        index++;
        render();
      } else {
        endScreen();
      }
    });

    el("btnRestart").addEventListener("click", restart);

    el("btnNext").addEventListener("click", ()=> next());

    el("toggleShuffle").addEventListener("click", toggleShuffle);
    el("toggleStrict").addEventListener("click", toggleStrict);

    el("btnOpenBank").addEventListener("click", openBank);
    el("btnClose").addEventListener("click", closeBank);
    el("modal").addEventListener("click", (e)=>{
      if(e.target === el("modal")) closeBank();
    });

    // init
    buildDeck();
    el("qTotal").textContent = String(scenarioBank.length);
    el("startStamp").textContent = formatDateTime(sessionStart);
    el("nowStamp").textContent = formatDateTime(new Date());
    render();
    startTimers();
  </script>
</body>
</html>
