<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CS11 Game — Electoral College & Presidency</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e7eefc; --muted:#a8b4cf; --accent:#7aa2ff;
      --good:#2bd576; --bad:#ff5c7a; --border: rgba(255,255,255,0.10);
      --shadow: 0 18px 55px rgba(0,0,0,.35); --radius:18px; --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--sans);color:var(--text);
      background: radial-gradient(900px 500px at 20% 0%, rgba(122,162,255,.22), transparent 55%),
                  radial-gradient(900px 500px at 80% 10%, rgba(255,92,122,.10), transparent 60%),
                  var(--bg);
      min-height:100vh;padding:24px;
    }
    .wrap{max-width:1100px;margin:0 auto;}
    h1{font-size:1.35rem;margin:0 0 10px 0}
    .sub{color:var(--muted);margin:0 0 18px 0;line-height:1.35}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background: rgba(17,26,46,.82);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.06);border:1px solid var(--border);
      font-size:.92rem;
    }
    .pill strong{font-family:var(--mono);font-weight:900}
    .btn{
      cursor:pointer;border:none;border-radius:12px;padding:10px 12px;
      color:var(--text);background: rgba(122,162,255,.18);
      border:1px solid rgba(122,162,255,.35);
      transition: transform .06s ease, background .15s ease;
      font-weight:900;
    }
    .btn:hover{background: rgba(122,162,255,.26)}
    .btn:active{transform: scale(.98)}
    .btn.secondary{background: rgba(255,255,255,.06);border:1px solid var(--border);font-weight:800}
    .btn.danger{background: rgba(255,92,122,.14);border:1px solid rgba(255,92,122,.35);}
    .label{color:var(--muted);font-size:.85rem}
    .mono{font-family:var(--mono)}
    .value{font-weight:900}
    .qbox h2{margin:0 0 10px 0;font-size:1.08rem}
    .prompt{font-size:1.03rem;line-height:1.38;margin:8px 0 12px 0}
    .choices{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.choices{grid-template-columns:1fr}}
    .choice{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius: var(--radius2);
      background: rgba(255,255,255,.05);border:1px solid var(--border);
      cursor:pointer;user-select:none;
    }
    .choice:hover{background: rgba(255,255,255,.075)}
    .choice .tag{
      width:28px;height:28px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(122,162,255,.18);
      border:1px solid rgba(122,162,255,.28);
      font-weight:900;flex:0 0 auto;
    }
    .choice.correct{border-color: rgba(43,213,118,.55);background: rgba(43,213,118,.10)}
    .choice.wrong{border-color: rgba(255,92,122,.55);background: rgba(255,92,122,.10)}
    .feedback{margin-top:12px;padding:12px;border-radius:14px;border:1px solid var(--border);background: rgba(255,255,255,.04);display:none}
    .feedback.good{display:block;border-color: rgba(43,213,118,.45);background: rgba(43,213,118,.08)}
    .feedback.bad{display:block;border-color: rgba(255,92,122,.45);background: rgba(255,92,122,.08)}
    .feedback .title{font-weight:900;margin-bottom:6px}
    .teacherPanel{display:none;margin-top:12px;padding:12px;border-radius:14px;border:1px dashed rgba(255,255,255,.25);background: rgba(255,255,255,.03)}
    .teacherPanel.show{display:block}
    #timeBox .row2{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media (max-width:860px){#timeBox .row2{grid-template-columns:repeat(2,minmax(0,1fr));}}
    pre{white-space:pre-wrap;word-break:break-word;margin:0;font-family:var(--mono);font-size:.92rem;line-height:1.35}
    .tiny{font-size:.86rem;color:var(--muted)}
    .divider{height:1px;background: var(--border); margin:12px 0;}
    .input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background: rgba(0,0,0,.18);color:var(--text);outline:none;font-weight:900;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <h1>CS11 — Electoral College & Presidency (12th, 22nd, 23rd, 25th)</h1>
        <p class="sub">Focus: identify amendment + match the “trigger.” Includes the tricky DC distractor: DC votes for <strong>electors</strong>, not “directly for president.”</p>
      </div>
      <div class="spacer"></div>
      <button class="btn secondary" id="toggleTeacherBtn" title="Teacher Mode: ?teacher=1 or Shift+T">Teacher Mode</button>
      <button class="btn danger" id="resetBtn">Reset</button>
    </div>

    <div class="divider"></div>

    <div id="startCard" class="row" style="gap:12px;">
      <div style="flex:1;min-width:260px;">
        <div class="label">Student Name (required)</div>
        <input id="nameInput" class="input" placeholder="Type first + last name" autocomplete="off" />
        <div class="tiny">Name appears in timer + submission summary.</div>
      </div>
      <button class="btn" id="startBtn">Start Game</button>
    </div>

    <div id="timeBox" class="card" style="margin-top:12px;display:none;">
      <div class="row2">
        <div><div class="label">Student</div><div id="studentNameDisplay" class="value">—</div></div>
        <div><div class="label">Start Time</div><div id="startStamp" class="value">—</div></div>
        <div><div class="label">Elapsed</div><div id="timerClock" class="value mono">00:00</div></div>
        <div><div class="label">Last Action</div><div id="lastActionStamp" class="value">—</div></div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="pill">Question: <strong id="qNum">—</strong>/<strong id="qTotal">—</strong></div>
      <div class="pill">Correct: <strong id="correctCount">0</strong></div>
      <div class="pill">Attempts: <strong id="attemptCount">0</strong></div>
      <div class="pill">Accuracy: <strong id="accuracy">0</strong>%</div>
      <div class="spacer"></div>
      <button class="btn secondary" id="nextBtn" disabled>Next</button>
    </div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card qbox">
      <h2>Question</h2>
      <div id="prompt" class="prompt">Enter your name and click Start.</div>
      <div class="choices" id="choices"></div>

      <div id="feedback" class="feedback">
        <div class="title" id="fbTitle"></div>
        <div id="fbText" class="tiny"></div>
      </div>

      <div id="teacherPanel" class="teacherPanel">
        <div class="label">Teacher Mode is ON</div>
        <div class="tiny">Explanations appear only after an incorrect answer.</div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:1.08rem;">Rules</h2>
      <ul class="tiny" style="margin:0 0 10px 18px;line-height:1.5;">
        <li>Wrong answers recycle until mastered.</li>
        <li>Teacher Mode shows explanations only after wrong.</li>
        <li>Submission summary appears only at <strong>100% accuracy</strong>.</li>
      </ul>
      <div class="divider"></div>
      <section id="submissionBox" class="card" style="display:none;">
        <div class="label">Submission Summary (Screenshot this)</div>
        <pre id="submissionText" style="margin-top:10px;"></pre>
      </section>
    </div>
  </div>
</div>

<script>
const $ = (sel) => document.querySelector(sel);
const shuffle = (arr) => {
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
};

const Time = (() => {
  const pad = (n)=>String(n).padStart(2,'0');
  const fmtClock = (ms)=>{
    const s=Math.floor(ms/1000), m=Math.floor(s/60), r=s%60;
    return `${pad(m)}:${pad(r)}`;
  };
  const fmtStamp = (d=new Date()) => d.toLocaleString([], {
    year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
  return { fmtClock, fmtStamp };
})();

const Run = {
  startedAt:null, timerId:null, lastActionAt:null, qShownAt:null, log:[],
  init(studentName){
    this.startedAt=Date.now();
    this.lastActionAt=Date.now();
    this.qShownAt=Date.now();
    $("#studentNameDisplay").textContent = studentName||"—";
    $("#startStamp").textContent = Time.fmtStamp(new Date(this.startedAt));
    $("#lastActionStamp").textContent = Time.fmtStamp(new Date(this.lastActionAt));
    this.timerId=setInterval(()=>$("#timerClock").textContent=Time.fmtClock(Date.now()-this.startedAt),250);
    this.pushLog({type:"START",detail:"Game started",stamp:this.lastActionAt});
  },
  markAction(type, detail){
    this.lastActionAt=Date.now();
    $("#lastActionStamp").textContent = Time.fmtStamp(new Date(this.lastActionAt));
    this.pushLog({type,detail,stamp:this.lastActionAt});
  },
  markQuestionShown(qIndex, qLabel){
    this.qShownAt=Date.now();
    this.markAction("Q_SHOWN", `Q${qIndex+1}: ${qLabel||""}`.trim());
  },
  recordAnswer({ qIndex, prompt, choiceLabel, choiceText, isCorrect, correctLabel, reasonText }){
    const now=Date.now();
    const timeOnQ=Math.max(0, Math.round((now-(this.qShownAt||now))/1000));
    this.pushLog({
      type: isCorrect ? "ANSWER_CORRECT" : "ANSWER_WRONG",
      stamp: now, qIndex, timeOnQ, prompt,
      choice: `${choiceLabel}. ${choiceText}`,
      correct: correctLabel||"",
      reason: reasonText||""
    });
    this.lastActionAt=now;
    $("#lastActionStamp").textContent=Time.fmtStamp(new Date(now));
  },
  pushLog(e){this.log.push(e);},
  elapsedMs(){return this.startedAt ? (Date.now()-this.startedAt) : 0;},
  buildSummary({ studentName, accuracy, correctCount, totalCount }){
    const endTime=new Date();
    const elapsed=Time.fmtClock(this.elapsedMs());
    const rows=this.log.filter(e=>e.type==="ANSWER_CORRECT"||e.type==="ANSWER_WRONG")
      .map(e=>{
        const stamp=Time.fmtStamp(new Date(e.stamp));
        const icon=e.type==="ANSWER_CORRECT"?"✅":"❌";
        return `${icon} ${stamp} | Q${(e.qIndex??0)+1} | +${e.timeOnQ}s | ${e.choice} | Correct: ${e.correct}`;
      });
    return [
      `GAME:    CS11 — Electoral College & Presidency`,
      `STUDENT: ${studentName||"—"}`,
      `START:   ${Time.fmtStamp(new Date(this.startedAt))}`,
      `END:     ${Time.fmtStamp(endTime)}`,
      `ELAPSED: ${elapsed}`,
      `SCORE:   ${correctCount}/${totalCount} (${accuracy}%)`,
      ``,
      `ANSWER LOG:`,
      ...(rows.length?rows:[`(no answers logged)`])
    ].join("\n");
  }
};

// 24 questions
const QUESTIONS = [
  // 12th — Jefferson/Burr tie
  { id:"CS11-12-1", prompt:"Which amendment created separate Electoral College ballots for president and vice president?", choices:["12th","22nd","23rd","25th"], answer:0,
    explain:"12th changed Electoral College procedure: separate ballots for president and vice president."},
  { id:"CS11-12-2", prompt:"Your class trigger for the 12th Amendment is…", choices:[
      "The electoral tie between Thomas Jefferson and Aaron Burr",
      "FDR’s four terms",
      "JFK’s assassination and Johnson’s health risk",
      "DC’s growing population"
    ], answer:0,
    explain:"12th was prompted by the Jefferson–Burr tie and the need to avoid that system failure again."},
  { id:"CS11-12-3", prompt:"What problem did the 12th Amendment try to reduce?", choices:[
      "A tie where president and vice president candidates end up equal in electoral votes",
      "Poll taxes preventing voting",
      "Presidents serving too many terms",
      "DC lacking any electors"
    ], answer:0,
    explain:"12th = separate ballots to prevent the tie/selection chaos seen in early elections."},

  // 22nd — term limits; FDR 4 terms + near-dictatorship framing
  { id:"CS11-22-1", prompt:"Which amendment established presidential term limits?", choices:["22nd","12th","23rd","25th"], answer:0,
    explain:"22nd Amendment: limits presidents to two elected terms (with specific constitutional details)."},
  { id:"CS11-22-2", prompt:"Your class trigger for the 22nd Amendment focuses on…", choices:[
      "FDR’s four-term presidency and fear of growing presidential power",
      "Jefferson and Burr tying",
      "DC gaining electors",
      "Vietnam draft for 18-year-olds"
    ], answer:0,
    explain:"You connect 22nd to FDR’s four terms and concerns about expanded executive power (New Deal, court-packing, etc.)."},
  { id:"CS11-22-3", prompt:"Which scenario most directly relates to the purpose of the 22nd Amendment?", choices:[
      "Preventing one person from staying president for many terms in a row",
      "Allowing DC to vote for electors",
      "Separating ballots for president and vice president",
      "Creating a process for presidential disability"
    ], answer:0,
    explain:"22nd is about limiting presidential tenure."},

  // 23rd — DC electors (NOT “vote for president directly”)
  { id:"CS11-23-1", prompt:"Which amendment granted the District of Columbia electoral votes?", choices:["23rd","22nd","12th","25th"], answer:0,
    explain:"23rd gave DC electoral votes based on its growing population."},
  { id:"CS11-23-2", prompt:"Your class trigger for the 23rd Amendment is…", choices:[
      "DC’s growing population and the push to include DC in presidential elections through electors",
      "FDR’s four terms",
      "Jefferson–Burr tie",
      "JFK assassination"
    ], answer:0,
    explain:"23rd responds to DC population growth and representation in presidential elections via electors."},
  { id:"CS11-23-3", prompt:"Which statement is MOST accurate about DC under the 23rd Amendment?", choices:[
      "DC residents vote for electors, not directly for the president",
      "DC residents vote directly for the president, not electors",
      "DC became a state",
      "DC receives electoral votes equal to California"
    ], answer:0,
    explain:"Your key ‘trap’: Americans do not vote directly for president; we vote for electors. DC gained that elector process."},
  { id:"CS11-23-4", prompt:"On the OST, the main distractor about the 23rd Amendment is…", choices:[
      "‘Enabled DC residents to vote for President’ (too simplistic / incorrect framing)",
      "‘Created presidential term limits’",
      "‘Banned poll taxes’",
      "‘Lowered voting age to 18’"
    ], answer:0,
    explain:"The common trap wording is ‘vote for President.’ Better phrasing: vote for presidential electors."},

  // 25th — JFK assassination, LBJ heart risk, succession/disability process
  { id:"CS11-25-1", prompt:"Which amendment clarified presidential succession and disability procedures?", choices:["25th","23rd","22nd","12th"], answer:0,
    explain:"25th sets processes for succession and presidential disability (VP vacancy, temporary transfer, etc.)."},
  { id:"CS11-25-2", prompt:"Your class trigger for the 25th Amendment is…", choices:[
      "JFK’s assassination and concerns about disability/succession (LBJ’s health and lack of a clear process)",
      "Jefferson–Burr tie",
      "FDR’s four terms",
      "Vietnam draft"
    ], answer:0,
    explain:"25th responds to uncertainty revealed by JFK’s assassination and questions about disability + replacing a VP."},
  { id:"CS11-25-3", prompt:"Which situation is most directly addressed by the 25th Amendment?", choices:[
      "A president is alive but unable to perform duties due to disability/medical issue",
      "A tie in electoral votes between candidates",
      "DC wants more electors than states",
      "Women demand suffrage"
    ], answer:0,
    explain:"25th covers disability and succession mechanics."},

  // How EC works basics (aligned with CS11 elaboration)
  { id:"CS11-EC-1", prompt:"Electoral votes for a state are based on the number of…", choices:[
      "Representatives + Senators",
      "Only Representatives",
      "Only Senators",
      "Supreme Court justices"
    ], answer:0,
    explain:"Electoral votes = House reps + 2 Senators."},
  { id:"CS11-EC-2", prompt:"To win the presidency, a candidate must secure…", choices:[
      "A majority of the total electoral votes",
      "A majority of the popular vote in every state",
      "A majority of the Supreme Court",
      "A two-thirds vote of Congress"
    ], answer:0,
    explain:"CS11: majority of total electoral votes is required to secure presidency."},

  // Mixed identification
  { id:"CS11-MIX-1", prompt:"Match: Jefferson–Burr tie → ?", choices:["12th","22nd","23rd","25th"], answer:0, explain:"Jefferson–Burr tie is the trigger tied to the 12th Amendment."},
  { id:"CS11-MIX-2", prompt:"Match: FDR served four terms → ?", choices:["22nd","12th","23rd","25th"], answer:0, explain:"FDR’s four terms is your class trigger for the 22nd."},
  { id:"CS11-MIX-3", prompt:"Match: DC population growth → ?", choices:["23rd","12th","22nd","25th"], answer:0, explain:"DC population growth aligns to the 23rd."},
  { id:"CS11-MIX-4", prompt:"Match: succession/disability confusion after JFK → ?", choices:["25th","23rd","22nd","12th"], answer:0, explain:"JFK assassination era concerns → 25th."},

  // Distinguish from voting rights amendments
  { id:"CS11-TRICK-1", prompt:"Which amendment listed here is NOT a CS11 ‘structure/function’ amendment?", choices:["26th","12th","22nd","25th"], answer:0,
    explain:"26th is a voting rights amendment (age 18). CS11 focuses on 12th/22nd/23rd/25th."},
  { id:"CS11-TRICK-2", prompt:"Which amendment banned poll taxes?", choices:["24th","12th","22nd","23rd"], answer:0,
    explain:"24th is voting rights (poll taxes), not Electoral College/presidency structure."},

  // Additional reinforcement items
  { id:"CS11-ADD-1", prompt:"Which amendment was designed to avoid the Electoral College producing a tie like Jefferson vs Burr?", choices:["12th","23rd","25th","22nd"], answer:0,
    explain:"12th introduced separate ballots for president and VP to reduce tie risk."},
  { id:"CS11-ADD-2", prompt:"Which amendment ensures DC has electors even though it is not a state?", choices:["23rd","22nd","25th","12th"], answer:0,
    explain:"23rd grants DC electoral votes."},
  { id:"CS11-ADD-3", prompt:"Which amendment most directly limits the potential for a president to remain in power for decades?", choices:["22nd","25th","23rd","12th"], answer:0,
    explain:"22nd limits presidential terms."}
];

const state = {
  teacherMode:false, started:false, studentName:"",
  deck:[], i:0, correct:0, attempts:0,
  missedQueue:[], answeredCorrectly:new Set(),
  currentChoices:[], selectedIndex:null, currentCorrectIndex:0
};

function parseTeacherFromURL(){
  const u=new URL(location.href);
  return u.searchParams.get("teacher")==="1";
}
function setTeacherMode(on){
  state.teacherMode=!!on;
  $("#toggleTeacherBtn").textContent = state.teacherMode ? "Teacher Mode: ON" : "Teacher Mode";
  $("#teacherPanel").classList.toggle("show", state.teacherMode);
  if(state.started) Run.markAction("TEACHER_MODE", state.teacherMode ? "ON" : "OFF");
}
function resetUI(){
  $("#qNum").textContent="—";$("#qTotal").textContent="—";
  $("#correctCount").textContent="0";$("#attemptCount").textContent="0";$("#accuracy").textContent="0";
  $("#prompt").textContent="Enter your name and click Start.";
  $("#choices").innerHTML="";
  $("#feedback").style.display="none";
  $("#nextBtn").disabled=true;
  $("#submissionBox").style.display="none";
  $("#submissionText").textContent="";
  $("#timeBox").style.display="none";
  $("#startCard").style.display="flex";
}
function accuracyPct(){return state.attempts?Math.round((state.correct/state.attempts)*100):0;}
function updateHud(){
  $("#qNum").textContent = state.started ? String(state.i+1) : "—";
  $("#qTotal").textContent = state.started ? String(state.deck.length) : "—";
  $("#correctCount").textContent = String(state.correct);
  $("#attemptCount").textContent = String(state.attempts);
  $("#accuracy").textContent = String(accuracyPct());
}
function buildDeck(){state.deck=shuffle(QUESTIONS);}

function renderQuestion(){
  $("#feedback").style.display="none";
  $("#nextBtn").disabled=true;
  state.selectedIndex=null;

  const q=state.deck[state.i];
  $("#prompt").textContent=q.prompt;

  const labeled=q.choices.map((t,idx)=>({text:t,origIndex:idx}));
  const shuffled=shuffle(labeled);
  state.currentChoices=shuffled;
  state.currentCorrectIndex=shuffled.findIndex(x=>x.origIndex===q.answer);

  const letters=["A","B","C","D"];
  $("#choices").innerHTML="";
  shuffled.forEach((opt,idx)=>{
    const div=document.createElement("div");
    div.className="choice";
    div.innerHTML=`<div class="tag">${letters[idx]}</div><div><div style="font-weight:850">${opt.text}</div></div>`;
    div.addEventListener("click",()=>selectChoice(idx));
    $("#choices").appendChild(div);
  });

  Run.markQuestionShown(state.i, q.id || "CS11");
  updateHud();
}
function selectChoice(idx){
  state.selectedIndex=idx;
  Array.from($("#choices").children).forEach((n,i)=>{
    n.classList.remove("correct","wrong");
    n.style.outline = (i===idx) ? "2px solid rgba(122,162,255,.55)" : "none";
  });
  $("#nextBtn").disabled=false;
}
function grade(){
  const q=state.deck[state.i];
  const letters=["A","B","C","D"];
  const picked=state.selectedIndex;
  const correct=state.currentCorrectIndex;
  if(picked==null) return;

  state.attempts++;
  Array.from($("#choices").children).forEach(n=>n.style.outline="none");
  const isCorrect = picked===correct;

  Run.recordAnswer({
    qIndex: state.i,
    prompt: q.prompt,
    choiceLabel: letters[picked],
    choiceText: state.currentChoices[picked].text,
    isCorrect,
    correctLabel: letters[correct],
    reasonText: q.explain || ""
  });

  const nodes=Array.from($("#choices").children);
  nodes.forEach((node,idx)=>{
    node.classList.remove("correct","wrong");
    if(idx===correct) node.classList.add("correct");
    if(idx===picked && !isCorrect) node.classList.add("wrong");
  });

  $("#feedback").style.display="block";
  if(isCorrect){
    state.correct++;
    state.answeredCorrectly.add(q.id);
    $("#fbTitle").textContent="Correct ✅";
    $("#fbText").textContent="Click Next.";
    $("#feedback").className="feedback good";
  } else {
    state.missedQueue.push(q);
    $("#fbTitle").textContent="Incorrect ❌";
    $("#fbText").textContent = state.teacherMode ? `Explanation: ${q.explain}` : "Try again later. Click Next.";
    $("#feedback").className="feedback bad";
  }

  updateHud();
  maybeUnlockSubmission();
}
function maybeUnlockSubmission(){
  const acc=accuracyPct();
  if(acc===100 && state.answeredCorrectly.size===QUESTIONS.length){
    $("#submissionBox").style.display="block";
    $("#submissionText").textContent = Run.buildSummary({
      studentName: state.studentName,
      accuracy: acc,
      correctCount: state.correct,
      totalCount: state.attempts
    });
  }
}
function next(){
  $("#nextBtn").disabled=true;
  if(state.i >= state.deck.length-1){
    if(state.missedQueue.length){
      const missed=state.missedQueue.slice();
      state.missedQueue=[];
      state.deck=shuffle(missed);
      state.i=0;
      renderQuestion();
      return;
    } else {
      state.deck=shuffle(QUESTIONS);
      state.i=0;
      renderQuestion();
      return;
    }
  } else {
    state.i++;
    renderQuestion();
  }
}
function startGame(){
  const name=($("#nameInput").value||"").trim();
  if(name.length<3){alert("Please enter your full name (first + last)."); $("#nameInput").focus(); return;}
  state.studentName=name;
  state.started=true;
  $("#startCard").style.display="none";
  $("#timeBox").style.display="block";
  buildDeck(); state.i=0;
  Run.init(name);
  Run.markAction("START_CLICK","Student started the game");
  $("#qTotal").textContent=String(state.deck.length);
  renderQuestion();
}

$("#startBtn").addEventListener("click", startGame);
$("#resetBtn").addEventListener("click", ()=>{ if(confirm("Reset local progress?")) location.reload(); });
$("#toggleTeacherBtn").addEventListener("click", ()=>setTeacherMode(!state.teacherMode));
$("#nextBtn").addEventListener("click", ()=>{
  if(!state.started) return;
  if(state.selectedIndex==null) return;
  grade();
  $("#nextBtn").disabled=false;
  $("#nextBtn").onclick=()=>{ $("#nextBtn").onclick=null; next(); };
});
window.addEventListener("keydown",(e)=>{
  if(e.shiftKey && e.key.toLowerCase()==="t"){ setTeacherMode(!state.teacherMode); }
  if(state.started && ["1","2","3","4"].includes(e.key)) selectChoice(parseInt(e.key,10)-1);
});

(function init(){
  resetUI();
  setTeacherMode(parseTeacherFromURL());
})();
</script>
</body>
</html>

